# Deploy an organization CA


[![Open this project in Cloud
Shell](http://gstatic.com/cloudssh/images/open-btn.png)](https://console.cloud.google.com/cloudshell/open?git_repo=https://github.com/incubate-co-th/fabric-course.git&page=editor&tutorial=org-ca.md)


Follow steps from [CA Deployment steps](https://hyperledger-fabric-ca.readthedocs.io/en/latest/deployguide/cadeploy.html).

# Steps
The [docker image](https://hub.docker.com/r/hyperledger/fabric-ca) from Hyperledger will be used instead of binary files.

There are 5 steps similar to deploying the TLS CA as:

0. Before you begin
1. Initialize the CA server
2. Modify the CA server configuration
3. Delete the CA server certificates
4. Start the CA server
5. Enroll the CA admin

## Step 0: Before you begin
Using the following commands, copy the organization CA TLS certificate and key pair that you generated in the previous step to a location that can be accessed by this CA server, for example fabric-ca-server-org1/tls. These are the fabric-ca-client/tls-ca/rcaadmin/msp/signcerts/cert.pem and fabric-ca-client/tls-ca/rcaadmin/msp/keystore/ files that were generated by the enroll command.

```bash
sudo mkdir Organizations/org1/fabric-ca-server-org/
sudo mkdir Organizations/org1/fabric-ca-server-org/tls
sudo cp Organizations/org1/fabric-ca-client/tls-ca/rcaadmin/msp/signcerts/cert.pem Organizations/org1/fabric-ca-server-org/tls && sudo cp Organizations/org1/fabric-ca-client/tls-ca/rcaadmin/msp/keystore/$(sudo ls Organizations/org1/fabric-ca-client/tls-ca/rcaadmin/msp/keystore) Organizations/org1/fabric-ca-server-org/tls/key.pem
```

The resulting folder structure is similar to the following diagram. 
- fabric-ca-server-org
  - tls
    - cert.pem
    - key.pem

## Step 1: Initialize the CA server

### Run the command to initialize the server

```bash
docker run --rm --name fabric-ca-server-org-init.org1 -v ${PWD}/Organizations/org1/fabric-ca-server-org:/root/fabric-ca-server-org hyperledger/fabric-ca:amd64-1.4.9 fabric-ca-server init -b rcaadmin:rcaadminpw -H /root/fabric-ca-server-org
```

The -b (bootstrap identity) option is required for initialization when LDAP is disabled. At least one bootstrap identity is required to start the Fabric CA server; this identity is the server administrator.

The -H(, --home string) option is for set server's home directory (default "/etc/hyperledger/fabric-ca-server")

## Step 2: Modify the CA server configuration

As we did with the TLS CA, we need to edit the generated `fabric-ca-server-config.yaml` file for the organization CA to modify the default configuration settings for your use case according to the Checklist for a production CA server.

At a minimum, you should edit the following fields:

### port
`port` - Enter the port that you want to use for this server. These instructions use 7055, but you can choose your port.

### tls

`tls.enabled` - Enable TLS by setting this value to true.

`tls.certfile` and `tls.keystore`- Enter the relative path and filenames for the TLS CA signed certificate and private key that were generated when the bootstrap admin for this CA was enrolled with the TLS CA. The signed certificate, cert.pem, was generated using the Fabric CA client and can be found under fabric-ca-client/tls-ca/rcaadmin/msp/signcerts/cert.pem. The private key is located under fabric-ca-client/tls-ca/rcaadmin/msp/keystore. The specified path name is relative to FABRIC_CA_CLIENT_HOME therefore if you are following the folder structure that is used throughout these instructions you can simply specify tls/cert.pem for the tls.certfile and tls/key.pem for the tls.keystore or you can specify the fully qualified path name.

### ca.name
`ca.name` - Give the organization CA a name by specifying a value in this parameter, for example org1-ca.

### csr.hosts
`csr.hosts` - Update this parameter to include this hostname and ip address where this server is running if it is different than what is already in the file.

### operations.listenAddress
`operations.listenAddress`: - If there is another CA running on this host, then you need to update this parameter to use a different port.

### csr.ca.pathlength
`csr.ca.pathlength`: This field is used to limit CA certificate hierarchy. Setting this value to 1 for the root CA means the root CA can issue intermediate CA certificates, but these intermediate CAs cannot in turn issue other CA certificates. In other words the intermediate CA cannot enroll other intermediate CAs, but it can issue enrollment certificates for users. The default value is 1.

### signing.profiles.ca.caconstraint.maxpathlen
`signing.profiles.ca.caconstraint.maxpathlen` - This field represents the maximum number of non-self-issued intermediate certificates that can follow this certificate in a certificate chain. If this will be a parent server for an intermediate CA, and you want that intermediate CA to act as a parent CA for another intermediate CA, this root CA needs to set this value to greater than 0 in the configuration .yaml file. See the instructions for the signing section. The default value is 0.

### operations.listenAddress
`operations.listenAddress`: - In the unlikely case that there is another node running on this host and port, then you need to update this parameter to use a different port.

## Step 3: Delete the CA server certificates

Delete:
- the fabric-ca-server-tls/ca-cert.pem file and, 
- the entire fabric-ca-server-tls/msp folder.

### Delete fabric-ca-server-tls/ca-cert.pem file
Run the command below:
```bash
sudo rm Organizations/org1/fabric-ca-server-org/ca-cert.pem
```
### Delete fabric-ca-server-tls/msp folder
Run the command below:
```bash
sudo rm -rf Organizations/org1/fabric-ca-server-org/msp
```

## Step 4: Start the CA server
Run the command below to start CA in docker containner in new cloudshell:

```bash
docker run --rm -p 7055:7055 --name fabric-ca-server-org.org1 -v ${PWD}/Organizations/org1/fabric-ca-server-org:/root/fabric-ca-server-org hyperledger/fabric-ca:amd64-1.4.9 fabric-ca-server start -H /root/fabric-ca-server-org
```

## Step 5: Enroll the CA admin

The final step for deploying the CA is to enroll the CA admin bootstrap identity which generates the node signed certificate and private key. The key-pair is required for this admin identity to be able to enroll other identities. Again we will use the Fabric CA client CLI to enroll the admin. You should have already setup the required folders in the Fabric CA client section.

### Create folder for CA client
```bash
sudo mkdir Organizations/org1/fabric-ca-client/org1-ca
```

### Copy the TLS CA root certificate file
```bash
cp Organizations/org1/fabric-ca-server-org/ca-cert.pem Organizations/org1/fabric-ca-client/tls-root-cert/tls-ca-cert.pem
```

Now you can use the Fabric CA client to generate the CA admin certificate and private key. You need this certificate and private key to be able to issue identities using this CA. We use the --mspdir flag on the enroll command to designate where to store the generated certificates. Run the command:

```bash
docker run --rm --name fabric-ca-client.org1 --link fabric-ca-server-org.org1:fabric-ca-server-org.org1 -v ${PWD}/Organizations/org1/fabric-ca-client:/root/fabric-ca-client -e FABRIC_CA_CLIENT_HOME=/root/fabric-ca-client  hyperledger/fabric-ca:amd64-1.4.9 fabric-ca-client enroll -d -u https://rcaadmin:rcaadminpw@fabric-ca-server-org.org1:7055 --tls.certfiles tls-root-cert/tls-ca-cert.pem --csr.hosts 'host1,*.fabric-ca-server-org.org1' --mspdir org1-ca/rcaadmin/msp
```

When this command runs, the enroll command creates the fabric-ca-client/org1-ca/rcaadmin/msp folder and contains the signed cert and private key for the organization CA.
